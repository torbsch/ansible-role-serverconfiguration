---
- name: Set timezone to Europe/Berlin
  timezone:
    name: Europe/Berlin

- name: Add ansible user ("{{ deployment_user }}") for deployment
  user:
    name: "{{ deployment_user }}"
    comment: ansible deployment
    shell: /bin/bash
    createhome: yes
    state: present

- name: Allow 'ansible' user ("{{ deployment_user }}") to have passwordless sudo
  lineinfile:
    dest: /etc/sudoers
    state: present
    insertafter: '^# User privilege specification'
    line: "{{ deployment_user }} ALL=(ALL) NOPASSWD: ALL"
    validate: 'visudo -cf %s'

- name: Add authorized SSH Keys
  authorized_key:
    user: "{{ deployment_user }}"
    state: present
    key: "{{ lookup('file', '{{ authorized_keys_path }}/{{ item.path }}' )}}"
  with_filetree: '{{ authorized_keys_path }}'

- name: Remove unauthorized SSH Keys
  authorized_key:
    user: "{{ deployment_user }}"
    state: absent
    key: "{{ lookup('file', '{{ unauthorized_keys_path }}/{{ item.path }}' )}}"
  with_filetree: '{{ unauthorized_keys_path }}'

- name: Add sudo user ("{{ sudo_user }}")
  user:
    name: "{{ sudo_user }}"
    comment: sudo user
    shell: /bin/bash
    createhome: yes
    group: sudo
    password: "{{ sudo_user_password | password_hash('sha512') }}"
    state: present

- name: Add authorized SSH Keys ("{{ sudo_user }}")
  authorized_key:
    user: ("{{ sudo_user }}")
    state: present
    key: "{{ lookup('file', '{{ authorized_keys_path }}/{{ item.path }}' )}}"
  with_filetree: '{{ authorized_keys_path }}'